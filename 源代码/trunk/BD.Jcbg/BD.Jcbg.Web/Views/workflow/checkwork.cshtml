@using BD.WorkFlow.Common;
@{
    ViewBag.Title = "工作审批";
    Layout = "~/Views/workflow/_workflowdo.cshtml";
}
@section head
{
    <script language="javascript" type="text/javascript">
        var g_ProcessId = '@ViewBag.ProcessId';
        var g_ReturnUrl = '@ViewBag.ReturnUrl';
        var g_Error = '@ViewBag.Error';
        var g_ActivityId = '@ViewBag.ActivityId';
        var g_TaskId = '@ViewBag.TaskId';
        var g_Serial = '@ViewBag.Serial';
        var g_ProcessInfo = null;
        var g_Activity = null;
        var g_NextActivitys = null;
        var g_DefaultUsers = null;
        var g_NoNextSteps = false;
        var g_NoNewProcess = false;
        var g_ParentDlgId = '@ViewBag.ParentDlgId';
        var g_Html = "@ViewBag.HasHtml";
        var g_Office = "@ViewBag.HasOffice";
        var g_Serial = "@ViewBag.SerialNo";
        var g_assist_users = null;
        var g_task_status = "@ViewBag.TaskStatus";
        var g_next_users = null;

        function hasHtml() {
            return g_Html == "1";
        }
        function hasOffice() {
            return g_Office == "1";
        }
        function hasAskAssist() {
            return g_task_status == "5";
        }
        $(function () {
            try {
                $("#tbViewProcess").hide();
                if (g_Error != "") {
                    $("#divbuttons").hide();
                    $("#divtoolbars").hide();
                    $.messager.alert('审批工作失败', g_Error, 'warning', function () {
                        colosePage(g_ReturnUrl, g_ParentDlgId);
                    });

                }
                else {
                    loadprocess(g_ProcessId);
                    loadDefaultUser();
                    initDialog();
                    initFileCtrl();
                    $("img.lazy").lazyload({
                        threshold: 1200,
                        skip_invisible: false
                    });
                    if (!hasHtml()) {
                        $("#tabMain").tabs("close", "流程表单");
                    }
                    if (!hasOffice()) {
                        $("#tabMain").tabs("close", "Office在线编辑");
                    }
                    else {
                        $("#checkwork_office").attr("src", "/workflow/startworkoframe?taskid=" + g_TaskId);
                        $("#tabMain").tabs("select", "Office在线编辑");
                    }
                    // 主页面
                    $("#divformmain").dialog({
                        fit: true,
                        modal: true,
                        shadow: true,
                        collapsible: false,
                        minimizable: false,
                        maximizable: false,
                        closable: false,
                        resizable: false,
                        closed: false,
                        maximized: true,
                        title: g_Activity.ActivityName + "(" + g_ProcessInfo.ProcessName + ")",
                        //buttons: "#divbuttons",//divtoolbars
                        toolbar: "#divbuttons"
                    });

                    $("#divviewdonetasks").dialog({
                        title: "审批过程查看",
                        collapsible: false,
                        minimizable: false,
                        maximizable: false,
                        resizable: false,
                        draggable: false,
                        closable: true,
                        modal: true,
                        fit: false,
                        cache: false,
                        width: 600,
                        height: 400,
                        buttons: [{
                            text: "关闭",
                            iconCls: "icon-cancel",
                            id: "cancelview",
                            handler: function () {
                                $("#divviewdonetasks").dialog("close");
                            }
                        }]
                    });
                }

                $("#divviewdonetasks_viewtab").tabs({
                    fit: true,
                    border: false,
                    plain: true
                });
                $("#divviewassist_viewtab").tabs({
                    fit: true,
                    border: false,
                    plain: true
                });

                $("#divviewdonetasks").dialog({
                    title: "审批过程查看",
                    closed: true
                });
                $("#divviewassist").dialog({
                    title: "协助办理过程查看",
                    closed: true
                });

            } catch (e) {
                $.messager.alert('初始化程序异常', e.message, 'warning');
            }
        });
        // 有office控件的，先选择office控件tab，加载完成后再切换
        function officeLoadCallback() {
            //if (hasHtml())
            //    $("#tabMain").tabs("select", "流程表单");
        }
        // 加载流程信息
        function loadprocess(processid) {
            try {
                $.ajax({
                    type: "POST",
                    url: "/workflow/getprocessinfo?id=" + g_ProcessId,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        if (data.code != 0 || data.record.length == 0)
                            $.messager.alert('无法获取流程信息', data.msg, 'info');
                        else {
                            g_ProcessInfo = data.record[0].Process;
                            for (var i = 0; i < data.record[0].ActivityCol.length; i++)
                                if (g_ActivityId == data.record[0].ActivityCol[i].Activityid)
                                    g_Activity = data.record[0].ActivityCol[i];
                        }

                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $("body").unmask();
                    },
                    beforeSend: function (XMLHttpRequest) {
                        $("body").mask("正在加载流程基本信息...");
                    }
                });
            } catch (e) {
                $.messager.alert('加载流程基本信息异常', e.message, 'warning');
            }
        }
        // 加载协办人员信息
        function loadAssistUsers(activityid) {
            try {
                $.ajax({
                    type: "POST",
                    url: "/workflow/getassistusers?id=" + g_ActivityId,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        g_assist_users = data;
                        if (g_assist_users == null || g_assist_users.length == 0)
                            $("#btnAssist").hide();
                        else {

                            $("#AssistUsers").combotree({
                                valueField: "id",
                                textField: "text",
                                mode: "local",
                                editable: false,
                                //panelHeight: 'auto',
                                data: g_assist_users,
                                onLoadSuccess: function () {
                                    if (g_assist_users.length > 0) {
                                        $("#AssistUsers").combotree("setValue", g_assist_users[0].UserId);
                                    }
                                },
                                onSelect: function (node) {
                                    //返回树对象
                                    var tree = $(this).tree;
                                    //选中的节点是否为叶子节点,如果不是叶子节点,清除选中
                                    var isLeaf = tree('isLeaf', node.target);
                                    if (!isLeaf) {
                                        //清除选中
                                        alert("部门不能选择，请选择具体人员");
                                        $('#AssistUsers').combotree('clear');
                                    }
                                }
                            });
                        }

                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $("body").unmask();
                    },
                    beforeSend: function (XMLHttpRequest) {
                        $("body").mask("正在加载协办人员信息...");
                    }
                });
            } catch (e) {
                $.messager.alert('加载协办人员信息异常', e.message, 'warning');
            }
        }
        // 初始化对话框
        function initDialog() {
            try {
                if (!g_Activity.IsPrint)
                    $("#btnPrint").hide();
                else
                    $("#btnSubmit").hide();
                if (g_ReturnUrl == "")
                    $("#btnBack").hide();

                if (!isCommentShow())
                    $("#divcomment").hide();
                if (!isNextStepShow())
                    $("#divnextstep").hide();
                else
                    loadNextSteps();

                if (!isUserSelectShow())
                    $("#divnextuser").hide();
                if (!isNewProcessShow())
                    $("#divnewprocess").hide();
                else
                    loadNewProcess();
                if (hasAskAssist()) {
                    $("#btnAssist").hide();
                    $("#btnSubmit").hide();
                    $("#btnPrint").hide();

                }
                else {
                    $("#tbViewAssistDonetTask").hide();
                    $("#btnUnassist").hide();
                    loadAssistUsers(g_ActivityId);
                }
                $("#divassistuser").dialog({
                    closed: true
                });

            } catch (e) {
                $.messager.alert('初始化对话框异常', e.message, 'warning');
            }
        }
        // 加载下一步选择
        function loadNextSteps() {
            try {
                $.ajax({
                    type: "POST",
                    url: "/workflow/getnextsteps?id=" + g_Activity.Activityid + "&serial=" + g_Serial,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        try {
                            g_NextActivitys = data;
                            if (g_NextActivitys.length == 0) {
                                $("#divnextstep").hide();
                                $("#divnextuser").hide();
                                g_NoNextSteps = true;
                            }
                            else {
                                $("#divnextstep").hide();
                                $("#btnPrint").hide();
                                $("#btnSubmit").hide();
                                if (isNextStepShow() && !hasAskAssist()) {
                                    for (var i = 0; i < g_NextActivitys.length; i++) {
                                        var activity = g_NextActivitys[i];
                                        //$("<a class='easyui-linkbutton' iconCls='icon-ok' onclick='nextstepClick(" + activity.Activityid + ")'>" + activity.ActivityName + "</a>").appendTo("#startwork_btn_td");
                                        //$("#startwork_btn_td").append("<a id='btn" + i + "' class='easyui-linkbutton' iconCls='icon-ok' onclick='nextstepClick(" + activity.Activityid + ")'>" + activity.ActivityName + "</a>");
                                        $("<a id='btn" + i + "' class='easyui-linkbutton' onclick='nextstepClick(" + activity.Activityid + ")'>" + activity.ActivityName + "</a>").prependTo("#startwork_btn_td");


                                    }
                                }
                                $.parser.parse($("#startwork_btn_td"));
                                $("#FixFieldNextSteps").combobox({
                                    valueField: "Activityid",
                                    textField: "ActivityName",
                                    mode: "local",
                                    editable: false,
                                    panelHeight: 'auto',
                                    data: g_NextActivitys,
                                    onLoadSuccess: function () {
                                        if (g_NextActivitys.length > 0) {
                                            var activity = g_NextActivitys[0];
                                            $("#FixFieldNextSteps").combobox("select", activity.Activityid);
                                        }
                                    },
                                    onSelect: function (record) {
                                        if (!g_Activity.HiddenNextStep && g_Activity.PermitSelectUser)
                                            loadActivityUser(record.Activityid);
                                    }
                                });
                            }
                        } catch (e) {
                            $.messager.alert('下一步骤数据分析错误', e.message, 'warning');
                        }
                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $("body").unmask();
                    },
                    beforeSend: function (XMLHttpRequest) {
                        $("body").mask("正在加载下一步骤信息...");
                    }
                });
            } catch (e) {
                $.messager.alert('加载下一步骤错误', e.message, 'warning');
            }
        }
        // 加载下一步审批人
        function loadActivityUser(activityid) {
            try {
                $.ajax({
                    type: "POST",
                    url: "/workflow/getactivityusers?id=" + g_Activity.Activityid + "&nextid=" + activityid + "&processid=" + g_ProcessId,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        try {
                            g_next_users = data;
                            $("#FixFieldNextUsers").combotree({
                                valueField: "id",
                                textField: "text",
                                mode: "local",
                                editable: false,
                                multiple: true,
                                checkbox: true,
                                onlyLeafCheck: true,
                                lines:true,
                                //panelHeight: 'auto',
                                data: data,
                                onLoadSuccess: function () {
                                    var realDefUsers = [];
                                    $.each(g_DefaultUsers, function (idx1, defuser) {
                                        var find = false;
                                        $.each(g_next_users, function (idx2, nextuser) {
                                            if (nextuser.id == defuser) {
                                                find = true;
                                                $.each(nextuser.children, function (idx3, nextsubuser) {
                                                    realDefUsers.push(nextsubuser.id);
                                                });
                                            }
                                        });
                                        if (!find)
                                            realDefUsers.push(defuser);
                                    });
                                    g_DefaultUsers = realDefUsers;
                                    $("#FixFieldNextUsers").combotree('setValues', g_DefaultUsers);
                                }
                            });

                            /*
                            $("#FixFieldNextUsers").combogrid({
                                idField: "UserId",
                                textField: "UserRealName",
                                mode: "local",
                                editable: false,
                                panWidth: 150,
                                multiple: true,
                                columns: [[
                                    { field: 'UserId', checkbox: true },
                                    { field: 'UserRealName', title: '', width: 100 }]]
                            });
                            $("#FixFieldNextUsers").combogrid("clear");
                            $("#FixFieldNextUsers").combogrid("grid").datagrid("loadData", data);
                            $("#FixFieldNextUsers").combogrid('setValues', getValidSelectUser(data, g_DefaultUsers));
                            if (data.length == 1) {
                                $("#FixFieldNextUsers").combogrid('setValue', data[0].UserId);
                            }*/

                        } catch (e) {
                            $.messager.alert('下一步骤用户数据分析错误', e.message, 'warning');
                        }
                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $("body").unmask();
                    },
                    beforeSend: function (XMLHttpRequest) {
                        $("body").mask("正在加载下一步骤用户信息...");
                    }
                });

            } catch (e) {
                $.messager.alert('加载下一步骤用户失败', e.message, 'warning');
            }
        }
        // 加载默认用户
        function loadDefaultUser() {
            try {
                $.ajax({
                    type: "POST",
                    url: "/workflow/getnextstepdefaultuser?activityid=" + g_Activity.Activityid + "&processid=" + g_ProcessId + "&serial=" + g_Serial,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        g_DefaultUsers = data;
                        if (isExitsFunction("getDefaultUsers")) {
                            var defUsers = getDefaultUsers();
                            if (defUsers != "") {
                                g_DefaultUsers = defUsers.split(",");
                            }
                        }
                        g_DefaultUsers = g_DefaultUsers.unique();
                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $("body").unmask();
                    },
                    beforeSend: function (XMLHttpRequest) {
                        $("body").mask("正在加载下一步骤用户信息...");
                    }
                });
            } catch (e) {
                $.messager.alert('加载默认用户失败', e.message, 'warning');
            }
        }
        // 获取用户列表中存在的默认用户
        function getValidSelectUser(allusers, selectusers) {
            var ret = new Array();
            if (selectusers == null)
                return ret;
            for (var i = 0; i < selectusers.length; i++) {
                for (var j = 0; j < allusers.length; j++) {
                    if (selectusers[i] == allusers[j].UserId) {
                        ret[ret.length] = selectusers[i];
                        break;
                    }
                }
            }
            return ret;
        }
        // 加载新流程
        function loadNewProcess() {
            try {
                $.ajax({
                    type: "POST",
                    url: "/workflow/getnewprocess?id=" + g_Activity.Activityid,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        try {
                            if (data.length == 0) {
                                $("#divnewprocess").hide();
                                g_NoNewProcess = true;
                            }
                            else {
                                $("#FixFieldNewProcess").combogrid({
                                    idField: "Processid",
                                    textField: "ProcessName",
                                    mode: "local",
                                    editable: false,
                                    panWidth: 150,
                                    multiple: true,
                                    columns: [[
                                        { field: 'Processid', checkbox: true },
                                        { field: 'ProcessName', title: '', width: 100 }]]
                                });
                                $("#FixFieldNewProcess").combogrid("grid").datagrid("loadData", data);
                                if (g_Activity.Streamid != "") {
                                    var selectProcess = g_Activity.Streamid.split(",");
                                    $("#FixFieldNewProcess").combogrid('setValues', selectProcess);
                                }
                            }

                        } catch (e) {
                            $.messager.alert('新流程数据分析错误', e.message, 'warning');
                        }
                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $("body").unmask();
                    },
                    beforeSend: function (XMLHttpRequest) {
                        $("body").mask("正在加载新流程信息...");
                    }
                });
            } catch (e) {
                $.messager.alert('加载新流程信息错误', e.message, 'warning');
            }
        }
        function isCommentShow() {
            var ret = false;
            try {
                ret = !g_Activity.HiddenOpinion;
            } catch (err) {
                $.messager.alert('判断审批意见是否显示异常', e.message, 'warning');
            }
            return ret;
        }
        function isNextStepShow() {
            var ret = false;
            try {
                ret = !g_Activity.HiddenNextStep && !g_NoNextSteps;
            } catch (err) {
                $.messager.alert('判断下一步骤是否显示异常', e.message, 'warning');
            }
            return ret;
        }
        function isUserSelectShow() {
            var ret = false;
            try {
                ret = isNextStepShow() && g_Activity.PermitSelectUser;

            } catch (err) {
                $.messager.alert('判断下一步用户是否显示异常', e.message, 'warning');
            }
            return ret;
        }
        function isNewProcessShow() {
            var ret = false;
            try {
                ret = g_Activity.IsCreateStream && g_Activity.Streamid != "" && !g_Activity.StreamHidden && !g_NoNewProcess;
            } catch (err) {
                $.messager.alert('判断新建流程是否显示异常', e.message, 'warning');
            }
            return ret;
        }
        function backClick() {
            window.location = g_ReturnUrl;
        }
        function saveClick() {
            doSubmit(0);
        }
        function printClick() {
            doSubmit(1);
        }
        function submitClick() {
            doSubmit(1);
        }
        function getOtherParams(submit) {
            var ret = "";
            try {
                ret += "&FixFieldReturnUrl=" + encodeURIComponent(g_ReturnUrl) +
                        "&FixFieldTaskId=" + g_TaskId +
                        "&FixFieldProcessId=" + g_ProcessId +
                        "&FixFieldSubmit=" + submit;
                if (isCommentShow())
                    ret += "&FixFieldComment=" + encodeURIComponent($("#FixFieldComment").val());
                if (isNextStepShow())
                    ret += "&FixFieldNextSteps=" + encodeURIComponent($("#FixFieldNextSteps").combobox("getValue"));
                if (isUserSelectShow())
                    ret += "&FixFieldNextUsers=" + encodeURIComponent(arrayToStr($("#FixFieldNextUsers").combogrid("getValues"), ","));
                if (isNewProcessShow())
                    ret += "&FixFieldNewProcess=" + encodeURIComponent(arrayToStr($("#FixFieldNewProcess").combogrid("getValues"), ","));
            }
            catch (e) {
                $.messager.alert('提交获取额外参数错误', e, 'warning');
            }
            return ret;
        }
        // 实际提交
        function doSubmit(submit) {
            try {
                var extraparams = getOtherParams(submit);
                var extraparams2 = "";
                if (isExitsFunction("getExtraParams"))
                    extraparams2 = getExtraParams();
                if (extraparams2 != "") {
                    if (extraparams != "")
                        extraparams += "&";
                    extraparams += extraparams2;
                }
                if (extraparams != "")
                    extraparams = "?" + extraparams;
                $("#formbody").form('submit', {
                    url: "/workflow/docheckwork" + extraparams,
                    onSubmit: function (param) {
                        var ret = false;
                        try {
                            var isValid = $(this).form('validate');
                            if (!isValid)
                                return false;
                            if (submit == 1) {
                                if (isExitsFunction("checkSubmit") && !checkSubmit())
                                    return false;
                                if (!hasInvalidFileUpload() ||
                                    !checkNextStep(isNextStepShow(), "FixFieldNextSteps") ||
                                    !checkNextUsers(isUserSelectShow(), "FixFieldNextUsers"))
                                    return false;
                            }
                            $("#divformmain").mask("正在保存……");
                            ret = true;
                        }
                        catch (err) {
                            ret = false;
                            $.messager.alert('提示', err, 'info');
                        }
                        return ret;
                    },
                    success: function (data) {
                        try {
                            if ($("#divformmain").isMasked()) {
                                $("#divformmain").unmask();
                            }
                            var data = eval('(' + data + ')');
                            var code = data.code;
                            var msg = data.msg;
                            if (code != 0) {
                                $.messager.alert('提示', msg, 'info');
                            }
                            else {
                                if (msg != "")
                                    g_ReturnUrl = msg;
                                var str = submit == 1 ? "提交成功！" : "临时保存成功！";
                                var offError = false;
                                if (hasOffice()) {
                                    if (!window.frames["checkwork_office"].Save(data.other)) {
                                        str = "保存Office文档失败";
                                        offError = true;
                                    }
                                }
                                $.messager.alert('提示', str, 'info', function () {

                                    colosePage(g_ReturnUrl, g_ParentDlgId);


                                });
                            }
                        }
                        catch (err) {
                            $.messager.alert('提示', err, 'info');
                        }
                    }
                });
            }
            catch (err) {
                $.messager.alert('提示', err, 'info');
            }
        }

        function viewProcess() {
            try {
                $("#divviewprocess").dialog({
                    title: g_ProcessInfo.ProcessName + "-预览",
                    collapsible: false,
                    minimizable: false,
                    maximizable: false,
                    resizable: false,
                    draggable: false,
                    closable: true,
                    modal: true,
                    fit: true,
                    cache: false,
                    content: "<iframe width='100%' height='99%' name='workflow_templates_frm' id='workflow_templates_frm' frameborder='0' scrolling='auto' src='/flow/FlowDesigner.html?edit=0&key=" + g_ProcessId + "'></iframe>",
                    buttons: [{
                        text: "关闭",
                        iconCls: "icon-cancel",
                        id: "btn_cancelview",
                        handler: function () {
                            $("#divviewprocess").dialog("close");
                        }
                    }]
                });
            } catch (e) {
                $.messager.alert('预览异常', e.message, 'warning');
            }
        }
        function viewDoneTasks() {
            try {
                $('#divviewdonetasks_viewtable2').datagrid({
                    title: '',
                    loadMsg: "正在加载……",
                    border: false,
                    url: '/workflow/getdonetasks?serial=' + g_Serial,
                    rownumbers: true,
                    nowrap: true,
                    idField: 'Taskid',
                    striped: false,
                    fit: true,
                    singleSelect: true,
                    pagination: false,
                    columns: [[
                    { field: 'TaskName', title: '任务名称', width: 100, sortable: false, align: "center" },
                    {
                        field: 'DateCompleted', title: '完成时间', width: 120, sortable: true, align: "center",
                        formatter: function (value, row, index) {
                            var timeVal = value;
                            if (timeVal == null || timeVal == "")
                                return "";
                            var dt = eval("new " + timeVal.substr(1, timeVal.length - 2));
                            return dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate() + " " + dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();
                        }
                    },
                    { field: 'GrantorRealName', title: '来自', width: 60, sortable: false, align: "center" },
                    { field: 'UserRealName', title: '完成人', width: 60, sortable: false, align: "center" },
                    {
                        field: 'IsBack', title: '退回件', width: 40, sortable: true, align: "center",
                        formatter: function (value, row, index) {
                            if (value)
                                return "是";
                            return "否";
                        }
                    },
                    { field: 'Opinion', title: '审批意见', width: 80, sortable: true, align: "center" }
                    ]]
                });
                $('#divviewdonetasks_viewtable1').datagrid({
                    title: '',
                    loadMsg: "正在加载……",
                    border: false,
                    url: '/workflow/gettodotasks?serial=' + g_Serial,
                    rownumbers: true,
                    nowrap: true,
                    idField: 'Taskid',
                    striped: false,
                    fit: true,
                    singleSelect: true,
                    pagination: false,
                    columns: [[
                    { field: 'TaskName', title: '任务名称', width: 100, sortable: false, align: "center" },
                    { field: 'UserRealName', title: '等待办理人', width: 70, sortable: false, align: "center" },
                    {
                        field: 'DateAccepted', title: '接收时间', width: 120, sortable: true, align: "center",
                        formatter: function (value, row, index) {
                            var timeVal = value;
                            if (timeVal == null || timeVal == "")
                                return "";
                            var dt = eval("new " + timeVal.substr(1, timeVal.length - 2));
                            return dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate() + " " + dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();
                        }
                    },

                    { field: 'PreUserRealName', title: '来自', width: 60, sortable: false, align: "center" },
                    {
                        field: 'IsBack', title: '退回件', width: 40, sortable: true, align: "center",
                        formatter: function (value, row, index) {
                            if (value)
                                return "是";
                            return "否";
                        }
                    },
                    {
                        field: 'TaskStatus', title: '状态', width: 60, sortable: false, align: "center",
                        formatter: function (value, row, index) {
                            if (value == 7)
                                return "已撤销";
                            return "办理中";
                        }
                    }
                    ]],
                    onLoadSuccess: function (data) {
                        if (data.length == 0)
                            $('#workflow_worktodo_viewtab').tabs('select', 1);
                        else
                            $('#workflow_worktodo_viewtab').tabs('select', 0);

                    }
                });
                $("#divviewdonetasks").dialog({
                    title: "审批过程查看",
                    collapsible: false,
                    minimizable: false,
                    maximizable: false,
                    resizable: false,
                    draggable: false,
                    closable: true,
                    closed:false,
                    modal: true,
                    fit: false,
                    cache: false,
                    width: 800,
                    height: 400,
                    buttons: [{
                        text: "关闭",
                        iconCls: "icon-cancel",
                        id: "cancelview",
                        handler: function () {
                            $("#divviewdonetasks").dialog("close");
                        }
                    }]
                });
            } catch (e) {
                $.messager.alert('审批过程查看异常', e.message, 'warning');
            }
        }
        function colosePage(url, divid) {
            try {
                if (divid != "" && url == "") {
                    //var $parent = self.parent.$;
                    //$parent('#' + divid).window('close', true);
                    parent.layer.closeAll();
                }
                if (url != "")
                    window.location = url;

            } catch (e) {
                $.messager.alert('关闭当前页面异常', e.message, 'warning');
            }
        }
        function assistClick() {
            try {
                $("#divassistuser").dialog({
                    fit: false,
                    modal: true,
                    shadow: true,
                    collapsible: false,
                    minimizable: false,
                    maximizable: false,
                    closable: true,
                    resizable: false,
                    closed: false,
                    maximized: false,
                    width: 300,
                    height: 160,
                    title: "请选择协办人员",
                    buttons: [{
                        text: "提交",
                        iconCls: 'icon-ok',
                        handler: function () {

                            /*
                             var isselect = 0;
                             for (var i = 0; i < g_assist_users.length; i++) {
                             if (g_assist_users[0].UserId == $("#AssistUsers").combotree('getValue')) {
                             isselect = 1;
                             break;
                             }
                             }
                             if (isselect == 1) {
                             submitAssistUser($("#AssistUsers").combotree('getValue'));
                             }
                             else {
                             alert("请选择协办用户！");
                             }*/
                            submitAssistUser($("#AssistUsers").combotree('getValue'));
                        }
                    }, {
                        text: "关闭",
                        iconCls: 'icon-cancel',
                        handler: function () {
                            $("#divassistuser").dialog('close');
                        }
                    }
                    ]
                });
            } catch (e) {
                $.messager.alert('显示协办人员异常', e.message, 'warning');
            }
        }
        function submitAssistUser(uername) {
            try {
                $.ajax({
                    type: "POST",
                    url: "/workflow/doaskassistwork?assistuser=" + encodeURIComponent(uername) + "&taskid=" + g_TaskId,
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        if (data.code != 0)
                            $.messager.alert('设置任务协助办理失败', data.msg, 'info');
                        else {
                            $.messager.alert('设置任务协助办理成功', "设置任务协助办理成功，当前任务已挂起，等待协办完成！", 'info', function () {
                                if (g_ReturnUrl != "")
                                    window.location = g_ReturnUrl;
                            });
                        }

                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $("body").unmask();
                    },
                    beforeSend: function (XMLHttpRequest) {
                        $("body").mask("正在提交...");
                    }
                });
            }
            catch (e) {
                $.messager.alert('设置任务协助办理异常', e.message, 'warning');
            }
        }
        function unassistClick() {
            try {
                $.messager.confirm('提示', '确定要撤销任务协助办理吗?', function (r) {
                    if (r) {
                        $.ajax({
                            type: "POST",
                            url: "/workflow/docancelassistwork?taskid=" + g_TaskId,
                            dataType: "json",
                            async: false,
                            success: function (data) {
                                if (data.code != 0)
                                    $.messager.alert('撤销任务协助办理失败', data.mg, 'info');
                                else {
                                    $.messager.alert('撤销任务协助办理成功', "撤销任务协助办理成功，可以办理该任务！", 'info', function () {

                                        $("#btnAssist").show();
                                        $("#btnPrint").show();
                                        $("#btnSubmit").show();
                                        if (!g_Activity.IsPrint)
                                            $("#btnPrint").hide();
                                        else
                                            $("#btnSubmit").hide();
                                        $("#tbViewAssistDonetTask").hide();
                                        $("#btnUnassist").hide();
                                        loadAssistUsers(g_ActivityId);
                                    });
                                }

                            },
                            complete: function (XMLHttpRequest, textStatus) {
                                $("body").unmask();
                            },
                            beforeSend: function (XMLHttpRequest) {
                                $("body").mask("正在提交...");
                            }
                        });
                    }
                });
            } catch (e) {
                $.messager.alert('撤销任务协助办理异常', e.message, 'warning');
            }

        }
        function viewAssistDoneTasks() {
            try {
                $('#divviewassist_viewtable2').datagrid({
                    title: '',
                    loadMsg: "正在加载……",
                    border: false,
                    url: '/workflow/getassistdonetasks?serial=' + g_Serial,
                    rownumbers: true,
                    nowrap: true,
                    idField: 'Taskid',
                    striped: false,
                    fit: true,
                    singleSelect: true,
                    pagination: false,
                    columns: [[
                    { field: 'TaskName', title: '任务名称', width: 100, sortable: false, align: "center" },
                    {
                        field: 'DateCompleted', title: '完成时间', width: 120, sortable: true, align: "center",
                        formatter: function (value, row, index) {
                            var timeVal = value;
                            if (timeVal == null || timeVal == "")
                                return "";
                            var dt = eval("new " + timeVal.substr(1, timeVal.length - 2));
                            return dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate() + " " + dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();
                        }
                    },
                    { field: 'GrantorRealName', title: '来自', width: 60, sortable: false, align: "center" },
                    { field: 'UserRealName', title: '完成人', width: 60, sortable: false, align: "center" },
                    {
                        field: 'IsBack', title: '退回件', width: 40, sortable: true, align: "center",
                        formatter: function (value, row, index) {
                            if (value)
                                return "是";
                            return "否";
                        }
                    },
                    { field: 'Opinion', title: '审批意见', width: 80, sortable: true, align: "center" }
                    ]]
                });
                $('#divviewassist_viewtable1').datagrid({
                    title: '',
                    loadMsg: "正在加载……",
                    border: false,
                    url: '/workflow/getassisttodotasks?serial=' + g_Serial,
                    rownumbers: true,
                    nowrap: true,
                    idField: 'Taskid',
                    striped: false,
                    fit: true,
                    singleSelect: true,
                    pagination: false,
                    columns: [[
                    { field: 'TaskName', title: '任务名称', width: 100, sortable: false, align: "center" },
                    { field: 'UserRealName', title: '等待办理人', width: 70, sortable: false, align: "center" },
                    {
                        field: 'DateAccepted', title: '接收时间', width: 120, sortable: true, align: "center",
                        formatter: function (value, row, index) {
                            var timeVal = value;
                            if (timeVal == null || timeVal == "")
                                return "";
                            var dt = eval("new " + timeVal.substr(1, timeVal.length - 2));
                            return dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate() + " " + dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();
                        }
                    },

                    { field: 'PreUserRealName', title: '来自', width: 60, sortable: false, align: "center" },
                    {
                        field: 'IsBack', title: '退回件', width: 40, sortable: true, align: "center",
                        formatter: function (value, row, index) {
                            if (value)
                                return "是";
                            return "否";
                        }
                    },
                    {
                        field: 'TaskStatus', title: '状态', width: 60, sortable: false, align: "center",
                        formatter: function (value, row, index) {
                            if (value == 7)
                                return "已撤销";
                            return "办理中";
                        }
                    }
                    ]],
                    onLoadSuccess: function (data) {
                        if (data.length == 0)
                            $('#workflow_worktodo_viewtab').tabs('select', 1);
                        else
                            $('#workflow_worktodo_viewtab').tabs('select', 0);

                    }
                });
                $("#divviewassist").dialog({
                    title: "协助办理过程查看",
                    collapsible: false,
                    minimizable: false,
                    maximizable: false,
                    resizable: false,
                    draggable: false,
                    closable: true,
                    modal: true,
                    fit: false,
                    cache: false,
                    width: 600,
                    height: 400,
                    buttons: [{
                        text: "关闭",
                        iconCls: "icon-cancel",
                        id: "cancelview",
                        handler: function () {
                            $("#divviewassist").dialog("close");
                        }
                    }]
                });
            } catch (e) {
                $.messager.alert('协助办理过程查看异常', e.message, 'warning');
            }
        }
        function nextstepClick(stepid) {
            //alert(stepid);
            try {
                $("#FixFieldNextSteps").combobox("select", stepid);
                var isValid = $("#formbody").form('validate');
                if (!isValid) {
                    $.messager.alert('表单内容不完整', '请确认表单内容填写正确！', 'warning');
                    return false;
                }
                else if (!hasInvalidFileUpload()) {
                    $.messager.alert('附件异常', '请确认附件上传！', 'warning');
                    return false;
                }
                else {
                    if (isUserSelectShow()) {
                        $("#divnextuser").dialog({
                            title: $("#FixFieldNextSteps").combobox("getText") + "-用户选择",
                            collapsible: false,
                            minimizable: false,
                            maximizable: false,
                            resizable: false,
                            draggable: false,
                            closable: true,
                            modal: true,
                            fit: false,
                            cache: false,
                            width: 500,
                            height: 400,
                            buttons: [{
                                text: "确定",
                                iconCls: "icon-ok",
                                id: "btn_submituser",
                                handler: function () {
                                    $("#divnextuser").dialog("close");
                                    submitClick();
                                }
                            }, {
                                text: "关闭",
                                iconCls: "icon-cancel",
                                id: "btn_canceluser",
                                handler: function () {
                                    $("#divnextuser").dialog("close");
                                }
                            }]
                        });
                    }
                    else {
                        submitClick();
                    }
                }
            } catch (e) {
                $.messager.alert('预览异常', e.message, 'warning');
            }



            //alert($("#FixFieldNextSteps").combobox("getValue"));
        }
    </script>
}
<div id="divformmain">
    <div id="tabMain" class="easyui-tabs" data-options="fit:true,border:false,plain:true">

        <div title="流程表单">
            <form id='formbody' method='post'>
                @Html.Raw(ViewBag.Html)
            </form>
        </div>
        <div title="Office在线编辑">
            <iframe width='100%' height='99%' name='checkwork_office' id='checkwork_office' frameborder='0' scrolling='auto' src=''></iframe>
        </div>
    </div>
</div>
<div id="divbuttons">
    <table cellpadding="0" cellspacing="0" style="width:100%">
        <tr>
            
            <td style="text-align:left">
                <div id="startwork_btn_td">
                    <a id="btnUnassist" class="easyui-linkbutton" iconcls="icon-unassist" onclick="unassistClick()">撤销协助办理</a>
                    <a id="btnAssist" class="easyui-linkbutton" iconcls="icon-assist" onclick="assistClick()">协助办理</a>
                    <a id="btnSubmit" class="easyui-linkbutton" iconcls="icon-ok" onclick="submitClick()">提交</a>
                    <a id="btnPrint" class="easyui-linkbutton" iconcls="icon-print" onclick="printClick()">打印</a>
                    <a id="btnSave" class="easyui-linkbutton" iconcls="icon-save" onclick="saveClick()">临时保存</a>
                    <a id="btnBack" class="easyui-linkbutton" iconcls="icon-back" onclick="backClick()">返回</a>
                    <a onclick="viewDoneTasks();" id="tbViewDoneTasks" class="easyui-linkbutton" iconcls="icon-flowdesign">审批过程查看</a>
                    <a onclick="viewAssistDoneTasks();" id="tbViewAssistDonetTask" class="easyui-linkbutton" iconcls="icon-assist">协助办理过程查看</a>
                </div>
            </td>
            <td style="text-align:right">
                <div id="divcomment" style="float:left;margin-left:5px;">
                    经办意见：<input id="FixFieldComment" name="FixFieldComment" style="width:100px;border: 1px solid #ddf; text-align:left;" />

                </div>
                <div id="divnextstep" style="float:left;margin-left:5px;">
                    提交下一步：<input id="FixFieldNextSteps" name="FixFieldNextSteps" style="width:150px" />
                </div>

                <div id="divnewprocess" style="float:left;margin-left:5px;">
                    创建新流程：<input id="FixFieldNewProcess" name="FixFieldNewProcess" style="width:150px" />
                </div>
            </td>
        </tr>
    </table>
</div>
<div id="divtoolbars">
    <table cellpadding="0" cellspacing="0" style="width:100%">
        <tr>
            <td style="width:120px">
                <a id="tbViewProcess" onclick="viewProcess()" class="easyui-linkbutton" iconcls="icon-flowdesign" plain="true">查看流程步骤</a>
                
                
            </td>

        </tr>
    </table>
</div>
<div id="divviewprocess"></div>
<div id="divviewdonetasks">
    <div id="divviewdonetasks_viewtab">
        <div title="审批中" data-options="closable:false">
            <table id="divviewdonetasks_viewtable1"></table>
        </div>
        <div title="已完成" data-options="closable:false">
            <table id="divviewdonetasks_viewtable2"></table>
        </div>
    </div>
</div>
<div id="divviewassist">
    <div id="divviewassist_viewtab">
        <div title="审批中" data-options="closable:false">
            <table id="divviewassist_viewtable1"></table>
        </div>
        <div title="已完成" data-options="closable:false">
            <table id="divviewassist_viewtable2"></table>
        </div>
    </div>
</div>
<div id="divassistuser">
    <br /><br />
    <center>协办人员：<input id="AssistUsers" name="AssistUsers" style="width:150px" /></center>
</div>
<div id="divviewnextusers">
    <div id="divnextuser" style="float:left;margin-left:5px;">
        下一步用户：<input id="FixFieldNextUsers" name="FixFieldNextUsers" style="width:150px" />
    </div>
</div>